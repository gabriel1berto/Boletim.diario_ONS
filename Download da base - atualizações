import requests
import os
import time
import datetime
from config import data_i, data_f

#funcao para ajustar para o formato do site
def str_data_BDO(data_i):
    str_date = str(data_i.strftime('%d-%m-%Y'))
    path1 = f'DIARIO_{str_date}.xlsx'
    return path1

#data_i = datetime.datetime(2023,1,27) #primeiro excel a ser lido
#data_f = datetime.datetime(2023,1,28) #ultimo excel a ser lido

i=1
while (data_i <= data_f):
#ajustar para o formato do site
    print(f"a data atual eh :{data_i}")
    data = str(data_i.strftime('%Y_%m_%d'))
    data_file = str_data_BDO(data_i)
    path = os.path.abspath(os.path.dirname(__file__))
    ano = data_i.strftime('%Y')
    mes = data_i.strftime('%m')
    path_full = os.path.join(path,"BDO",ano,mes)
    file = os.path.join(path_full, data_file)
    os.makedirs(path_full, exist_ok=True)
    print('buscaremos aqui: ', file)

    if os.path.isfile(file):
        print('arquivo existente')
        time.sleep(2)
    else:
        print('no file, vamos baixar agora')
        url = f'https://sdro.ons.org.br/SDRO/DIARIO/{data}/Html/{data_file}'
        response = requests.get(url, allow_redirects=True)

        if response.status_code == 200:
            with open(file, 'wb') as f:
                f.write(response.content)
        else:
            print(f"Failed to download the file. Response code: {response.status_code}")
        time.sleep(2)

    data_i = data_i + datetime.timedelta(days=1)
    i = i+1
    time.sleep(2)

#folder_path = os.path.dirname(os.path.realpath(__file__))
#file_path = os.path.join(folder_path, data_file)
